name: ðŸ§¹ Cleanup Test Data Delete Last 20 Articles

on:
  workflow_dispatch:
    # Allows manual triggering from the 'Actions' tab in GitHub

jobs:
  cleanup_articles:
    runs-on: ubuntu-latest
    
    # CRITICAL: This permission is required to commit the modified DB file back
    permissions:
      contents: write 
      
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4
        
      - name: 2. Execute SQLite Deletion Command
        # The 'sqlite3' tool is available on the Ubuntu runner.
        run: |
          # --- FILE PATH IS NOW CORRECTLY SET ---
          DB_FILE="news_articles.db" 
          
          if [ ! -f "$DB_FILE" ]; then
              echo "ERROR: Database file not found at $DB_FILE."
              exit 1
          fi

          echo "Attempting to delete the last 20 articles from $DB_FILE..."
          
          # --- IMPORTANT: VERIFY THIS SQL QUERY AGAINST YOUR SCHEMA ---
          # 1. Is your table named 'articles'?
          # 2. Is your timestamp column named 'created_at'?
          # 3. Is your ID column named 'id'?
          sqlite3 "$DB_FILE" "
              DELETE FROM articles 
              WHERE id IN (
                  SELECT id 
                  FROM articles 
                  ORDER BY created_at DESC 
                  LIMIT 20
              );
          "

          if [ $? -ne 0 ]; then
              echo "Error running SQLite command. Please check table/column names and SQL syntax."
              exit 1
          fi
          echo "âœ… Successfully executed SQLite deletion command."

      - name: 3. Commit and Push Modified DB File
        # Makes the change permanent in your repository
        run: |
          DB_PATH="news_articles.db"
          
          if git status --porcelain | grep "$DB_PATH"; then
            echo "Changes detected in $DB_PATH. Committing and pushing..."
            git config user.name "GitHub Actions Bot"
            git config user.email "actions@github.com"
            git add "$DB_PATH"
            # [skip ci] prevents this commit from triggering other workflows
            git commit -m "chore(data): Deleted last 20 articles for testing purposes [skip ci]"
            git push
            echo "âœ… Successfully updated the database in the repository."
          else
            echo "No change detected in $DB_PATH. Nothing to commit."
          fi
